# FinMod-Copilot 本地使用指南

## 📋 快速开始

### 1. 环境准备

```bash
# 进入项目目录
cd /workspaces/RM_Tools/finmod_copilot

# 安装依赖
pip install -r requirements.txt
```

### 2. 获取 Gemini API 密钥

1. 访问 [Google AI Studio](https://makersuite.google.com/app/apikey)
2. 使用 Google 账号登录
3. 点击 "创建 API 密钥" 或 "Get API Key"
4. 复制生成的 API 密钥

### 3. 设置 API 密钥

**方式一：设置环境变量（推荐）**

```bash
# Linux/Mac
export GOOGLE_API_KEY='你的API密钥'

# Windows CMD
set GOOGLE_API_KEY=你的API密钥

# Windows PowerShell
$env:GOOGLE_API_KEY='你的API密钥'
```

**方式二：在代码中设置**

```python
import os
os.environ['GOOGLE_API_KEY'] = '你的API密钥'
```

### 4. 运行演示程序

```bash
# 确保在项目根目录
cd /workspaces/RM_Tools

# 运行 Gemini 演示
python -m finmod_copilot.examples.demo_gemini
```

## 💡 基本使用示例

### 示例 1：翻译简单的 Excel 公式

```python
from finmod_copilot.translation.llm_translator import LLMTranslator

# 初始化翻译器（使用 Gemini）
translator = LLMTranslator(
    provider="gemini",
    model="gemini-1.5-pro",
    temperature=0.1
)

# Excel 公式
formula = "=SUM(A1:A10)"

# 翻译
prompt = f"将这个 Excel 公式转换为 Python 代码：{formula}"
python_code = translator.translate(prompt)

print(python_code)
```

### 示例 2：解析 Excel 文件

```python
from finmod_copilot.core.excel_parser import ExcelParser

# 创建解析器
parser = ExcelParser()

# 解析 Excel 文件
structure = parser.parse("你的财务模型.xlsx")

# 查看文件结构
print(f"工作表数量: {len(structure.sheets)}")
print(f"命名范围: {list(structure.named_ranges.keys())}")
print(f"是否包含 VBA: {structure.has_vba}")

# 获取所有公式
formulas = parser.get_formulas()
print(f"公式总数: {len(formulas)}")

# 查看前5个公式
for i, cell in enumerate(formulas[:5]):
    print(f"{i+1}. {cell.sheet_name}!{cell.address}: {cell.formula}")
```

### 示例 3：分析公式依赖关系

```python
from finmod_copilot.core.excel_parser import ExcelParser
from finmod_copilot.core.dependency_graph import DependencyGraph

# 解析 Excel
parser = ExcelParser()
structure = parser.parse("财务模型.xlsx")

# 构建依赖图
graph = DependencyGraph(structure)
graph.build()

# 获取计算顺序
calc_order = graph.get_calculation_order()
print(f"计算层级数: {len(calc_order)}")

# 查看统计信息
stats = graph.export_stats()
print(f"总单元格数: {stats['total_cells']}")
print(f"公式单元格数: {stats['formula_cells']}")
print(f"输入单元格数: {stats['input_cells']}")
```

### 示例 4：完整的公式翻译流程

```python
from finmod_copilot.core.excel_parser import ExcelParser
from finmod_copilot.core.formula_parser import FormulaParser
from finmod_copilot.translation.llm_translator import LLMTranslator

# 1. 解析 Excel 文件
excel_parser = ExcelParser()
structure = excel_parser.parse("财务模型.xlsx")

# 2. 获取所有公式
formulas = excel_parser.get_formulas()

# 3. 初始化 LLM 翻译器
translator = LLMTranslator(provider="gemini")

# 4. 分析和翻译公式
formula_parser = FormulaParser()

for cell in formulas[:3]:  # 翻译前3个公式作为示例
    # 解析公式
    parsed = formula_parser.parse(cell.formula)
    
    print(f"\n{'='*60}")
    print(f"位置: {cell.sheet_name}!{cell.address}")
    print(f"原始公式: {cell.formula}")
    print(f"公式类型: {parsed.formula_type.value}")
    print(f"复杂度: {parsed.complexity_score}/100")
    
    # 构建翻译提示
    prompt = f"""将以下 Excel 公式转换为 Python 代码：

原始公式: {cell.formula}
位置: {cell.sheet_name}!{cell.address}
类型: {parsed.formula_type.value}

要求：
1. 使用 pandas DataFrame 操作
2. 添加溯源注释
3. 处理边界情况
4. 使用向量化操作（如果可能）

假设数据在 DataFrame 'df' 中，工作表名称作为字典键。
"""
    
    # 翻译
    python_code = translator.translate(
        prompt,
        system_prompt="你是 Excel 到 Python 转换专家，专注于金融建模。"
    )
    
    print(f"\nPython 代码:\n{python_code}")
```

## 🔧 常用配置

### 选择不同的 Gemini 模型

```python
# 使用 Pro 版本（更好的质量，适合复杂公式）
translator = LLMTranslator(
    provider="gemini",
    model="gemini-1.5-pro"
)

# 使用 Flash 版本（更快更便宜，适合简单公式）
translator = LLMTranslator(
    provider="gemini",
    model="gemini-1.5-flash"
)
```

### 调整翻译参数

```python
translator = LLMTranslator(
    provider="gemini",
    model="gemini-1.5-pro",
    temperature=0.1,      # 降低随机性，提高一致性
    max_tokens=4096,      # 最大输出长度
    max_retries=3,        # API 错误重试次数
    timeout=60            # 超时时间（秒）
)
```

## 📁 项目文件结构

```
finmod_copilot/
├── 本地使用指南.md          ← 你正在看的文件
├── README.md               ← 项目总览
├── GEMINI_GUIDE.md         ← Gemini 详细使用指南
├── requirements.txt        ← Python 依赖
│
├── core/                   ← 核心解析模块
│   ├── excel_parser.py     # Excel 文件解析
│   ├── formula_parser.py   # 公式分析
│   ├── dependency_graph.py # 依赖关系图
│   └── vba_extractor.py    # VBA 代码提取
│
├── translation/            ← LLM 翻译层
│   └── llm_translator.py   # 多模型翻译器
│
└── examples/               ← 示例代码
    └── demo_gemini.py      # Gemini 演示程序
```

## 🎯 典型使用场景

### 场景 1：将 Excel 模型转为 Python 脚本

```python
# 1. 解析 Excel
parser = ExcelParser()
structure = parser.parse("valuation_model.xlsx")

# 2. 提取关键公式
formulas = parser.get_formulas("Calculations")  # 特定工作表

# 3. 逐个翻译并保存
translator = LLMTranslator(provider="gemini")
output_code = []

for cell in formulas:
    python_code = translator.translate(
        f"转换公式到Python: {cell.formula}"
    )
    output_code.append(python_code)

# 4. 保存结果
with open("output_model.py", "w", encoding="utf-8") as f:
    f.write("\n\n".join(output_code))
```

### 场景 2：提取并翻译 VBA 宏

```python
from finmod_copilot.core.vba_extractor import VBAExtractor

# 提取 VBA
extractor = VBAExtractor()
vba_structure = extractor.extract("model_with_macros.xlsm")

if vba_structure:
    # 获取业务逻辑函数
    business_funcs = extractor.get_business_logic_functions(vba_structure)
    
    # 翻译 VBA 函数
    translator = LLMTranslator(provider="gemini")
    
    for func in business_funcs[:5]:
        print(f"\n原始 VBA:\n{func.code}")
        
        prompt = f"""将此 VBA 函数转换为 Python:

{func.code}

要求：
1. 使用类型提示
2. 添加文档字符串
3. 遵循 Python 命名规范
"""
        python_code = translator.translate(prompt)
        print(f"\nPython 代码:\n{python_code}")
```

## ⚠️ 注意事项

1. **API 密钥安全**
   - 不要将 API 密钥提交到 Git
   - 使用环境变量存储密钥
   - 定期更换密钥

2. **速率限制**
   - Gemini 免费版：60 请求/分钟
   - 如遇到限制，添加延时：`time.sleep(1)`

3. **成本控制**
   - Gemini 1.5 Flash 更便宜，适合简单任务
   - 对于 1000 个公式，Flash 约 $0.06，Pro 约 $1.00

4. **数据隐私**
   - 敏感财务数据在发送前考虑匿名化
   - 或使用本地部署的 LLM（未来支持）

## 🐛 常见问题

### 问题 1：找不到模块

```bash
# 确保在正确的目录
cd /workspaces/RM_Tools

# 重新安装依赖
pip install -r finmod_copilot/requirements.txt
```

### 问题 2：API 密钥错误

```python
# 检查密钥是否设置
import os
print(os.getenv('GOOGLE_API_KEY'))

# 如果为 None，重新设置
os.environ['GOOGLE_API_KEY'] = '你的密钥'
```

### 问题 3：Excel 文件无法解析

```python
# 确保文件路径正确
from pathlib import Path
file_path = Path("你的文件.xlsx")
print(f"文件存在: {file_path.exists()}")
print(f"绝对路径: {file_path.absolute()}")
```

## 📚 更多资源

- **详细文档**: 查看 [GEMINI_GUIDE.md](GEMINI_GUIDE.md)
- **架构说明**: 查看 [ARCHITECTURE.md](ARCHITECTURE.md)
- **API 文档**: https://ai.google.dev/docs
- **获取 API 密钥**: https://makersuite.google.com/app/apikey

## 💬 获取帮助

如有问题：
1. 查看 [GEMINI_GUIDE.md](GEMINI_GUIDE.md) 的故障排除部分
2. 检查 GitHub Issues
3. 运行演示程序测试环境：`python -m finmod_copilot.examples.demo_gemini`
